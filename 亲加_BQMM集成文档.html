<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<style type="text/css">
.ef0,.f0 { color: #000000; } .eb0,.b0 { background-color: #000000; }
.ef1,.f1 { color: #AA0000; } .eb1,.b1 { background-color: #AA0000; }
.ef2,.f2 { color: #00AA00; } .eb2,.b2 { background-color: #00AA00; }
.ef3,.f3 { color: #AA5500; } .eb3,.b3 { background-color: #AA5500; }
.ef4,.f4 { color: #0000AA; } .eb4,.b4 { background-color: #0000AA; }
.ef5,.f5 { color: #AA00AA; } .eb5,.b5 { background-color: #AA00AA; }
.ef6,.f6 { color: #FF55FF; } .eb6,.b6 { background-color: #FF55FF; }
.ef7,.f7 { color: #AAAAAA; } .eb7,.b7 { background-color: #AAAAAA; }
.ef8, .f0 > .bold,.bold > .f0 { color: #555555; font-weight: normal; }
.ef9, .f1 > .bold,.bold > .f1 { color: #FF5555; font-weight: normal; }
.ef10,.f2 > .bold,.bold > .f2 { color: #55FF55; font-weight: normal; }
.ef11,.f3 > .bold,.bold > .f3 { color: #FFFF55; font-weight: normal; }
.ef12,.f4 > .bold,.bold > .f4 { color: #5555FF; font-weight: normal; }
.ef13,.f5 > .bold,.bold > .f5 { color: #FF55FF; font-weight: normal; }
.ef14,.f6 > .bold,.bold > .f6 { color: #55FFFF; font-weight: normal; }
.ef15,.f7 > .bold,.bold > .f7 { color: #FFFFFF; font-weight: normal; }
.eb8  { background-color: #555555; }
.eb9  { background-color: #FF5555; }
.eb10 { background-color: #55FF55; }
.eb11 { background-color: #FFFF55; }
.eb12 { background-color: #5555FF; }
.eb13 { background-color: #FF55FF; }
.eb14 { background-color: #55FFFF; }
.eb15 { background-color: #FFFFFF; }
.ef16 { color: #000000; } .eb16 { background-color: #000000; }
.ef17 { color: #00005f; } .eb17 { background-color: #00005f; }
.ef18 { color: #000087; } .eb18 { background-color: #000087; }
.ef19 { color: #0000af; } .eb19 { background-color: #0000af; }
.ef20 { color: #0000d7; } .eb20 { background-color: #0000d7; }
.ef21 { color: #0000ff; } .eb21 { background-color: #0000ff; }
.ef22 { color: #005f00; } .eb22 { background-color: #005f00; }
.ef23 { color: #005f5f; } .eb23 { background-color: #005f5f; }
.ef24 { color: #005f87; } .eb24 { background-color: #005f87; }
.ef25 { color: #005faf; } .eb25 { background-color: #005faf; }
.ef26 { color: #005fd7; } .eb26 { background-color: #005fd7; }
.ef27 { color: #005fff; } .eb27 { background-color: #005fff; }
.ef28 { color: #008700; } .eb28 { background-color: #008700; }
.ef29 { color: #00875f; } .eb29 { background-color: #00875f; }
.ef30 { color: #008787; } .eb30 { background-color: #008787; }
.ef31 { color: #0087af; } .eb31 { background-color: #0087af; }
.ef32 { color: #0087d7; } .eb32 { background-color: #0087d7; }
.ef33 { color: #0087ff; } .eb33 { background-color: #0087ff; }
.ef34 { color: #00af00; } .eb34 { background-color: #00af00; }
.ef35 { color: #00af5f; } .eb35 { background-color: #00af5f; }
.ef36 { color: #00af87; } .eb36 { background-color: #00af87; }
.ef37 { color: #00afaf; } .eb37 { background-color: #00afaf; }
.ef38 { color: #00afd7; } .eb38 { background-color: #00afd7; }
.ef39 { color: #00afff; } .eb39 { background-color: #00afff; }
.ef40 { color: #00d700; } .eb40 { background-color: #00d700; }
.ef41 { color: #00d75f; } .eb41 { background-color: #00d75f; }
.ef42 { color: #00d787; } .eb42 { background-color: #00d787; }
.ef43 { color: #00d7af; } .eb43 { background-color: #00d7af; }
.ef44 { color: #00d7d7; } .eb44 { background-color: #00d7d7; }
.ef45 { color: #00d7ff; } .eb45 { background-color: #00d7ff; }
.ef46 { color: #00ff00; } .eb46 { background-color: #00ff00; }
.ef47 { color: #00ff5f; } .eb47 { background-color: #00ff5f; }
.ef48 { color: #00ff87; } .eb48 { background-color: #00ff87; }
.ef49 { color: #00ffaf; } .eb49 { background-color: #00ffaf; }
.ef50 { color: #00ffd7; } .eb50 { background-color: #00ffd7; }
.ef51 { color: #00ffff; } .eb51 { background-color: #00ffff; }
.ef52 { color: #5f0000; } .eb52 { background-color: #5f0000; }
.ef53 { color: #5f005f; } .eb53 { background-color: #5f005f; }
.ef54 { color: #5f0087; } .eb54 { background-color: #5f0087; }
.ef55 { color: #5f00af; } .eb55 { background-color: #5f00af; }
.ef56 { color: #5f00d7; } .eb56 { background-color: #5f00d7; }
.ef57 { color: #5f00ff; } .eb57 { background-color: #5f00ff; }
.ef58 { color: #5f5f00; } .eb58 { background-color: #5f5f00; }
.ef59 { color: #5f5f5f; } .eb59 { background-color: #5f5f5f; }
.ef60 { color: #5f5f87; } .eb60 { background-color: #5f5f87; }
.ef61 { color: #5f5faf; } .eb61 { background-color: #5f5faf; }
.ef62 { color: #5f5fd7; } .eb62 { background-color: #5f5fd7; }
.ef63 { color: #5f5fff; } .eb63 { background-color: #5f5fff; }
.ef64 { color: #5f8700; } .eb64 { background-color: #5f8700; }
.ef65 { color: #5f875f; } .eb65 { background-color: #5f875f; }
.ef66 { color: #5f8787; } .eb66 { background-color: #5f8787; }
.ef67 { color: #5f87af; } .eb67 { background-color: #5f87af; }
.ef68 { color: #5f87d7; } .eb68 { background-color: #5f87d7; }
.ef69 { color: #5f87ff; } .eb69 { background-color: #5f87ff; }
.ef70 { color: #5faf00; } .eb70 { background-color: #5faf00; }
.ef71 { color: #5faf5f; } .eb71 { background-color: #5faf5f; }
.ef72 { color: #5faf87; } .eb72 { background-color: #5faf87; }
.ef73 { color: #5fafaf; } .eb73 { background-color: #5fafaf; }
.ef74 { color: #5fafd7; } .eb74 { background-color: #5fafd7; }
.ef75 { color: #5fafff; } .eb75 { background-color: #5fafff; }
.ef76 { color: #5fd700; } .eb76 { background-color: #5fd700; }
.ef77 { color: #5fd75f; } .eb77 { background-color: #5fd75f; }
.ef78 { color: #5fd787; } .eb78 { background-color: #5fd787; }
.ef79 { color: #5fd7af; } .eb79 { background-color: #5fd7af; }
.ef80 { color: #5fd7d7; } .eb80 { background-color: #5fd7d7; }
.ef81 { color: #5fd7ff; } .eb81 { background-color: #5fd7ff; }
.ef82 { color: #5fff00; } .eb82 { background-color: #5fff00; }
.ef83 { color: #5fff5f; } .eb83 { background-color: #5fff5f; }
.ef84 { color: #5fff87; } .eb84 { background-color: #5fff87; }
.ef85 { color: #5fffaf; } .eb85 { background-color: #5fffaf; }
.ef86 { color: #5fffd7; } .eb86 { background-color: #5fffd7; }
.ef87 { color: #5fffff; } .eb87 { background-color: #5fffff; }
.ef88 { color: #870000; } .eb88 { background-color: #870000; }
.ef89 { color: #87005f; } .eb89 { background-color: #87005f; }
.ef90 { color: #870087; } .eb90 { background-color: #870087; }
.ef91 { color: #8700af; } .eb91 { background-color: #8700af; }
.ef92 { color: #8700d7; } .eb92 { background-color: #8700d7; }
.ef93 { color: #8700ff; } .eb93 { background-color: #8700ff; }
.ef94 { color: #875f00; } .eb94 { background-color: #875f00; }
.ef95 { color: #875f5f; } .eb95 { background-color: #875f5f; }
.ef96 { color: #875f87; } .eb96 { background-color: #875f87; }
.ef97 { color: #875faf; } .eb97 { background-color: #875faf; }
.ef98 { color: #875fd7; } .eb98 { background-color: #875fd7; }
.ef99 { color: #875fff; } .eb99 { background-color: #875fff; }
.ef100 { color: #878700; } .eb100 { background-color: #878700; }
.ef101 { color: #87875f; } .eb101 { background-color: #87875f; }
.ef102 { color: #878787; } .eb102 { background-color: #878787; }
.ef103 { color: #8787af; } .eb103 { background-color: #8787af; }
.ef104 { color: #8787d7; } .eb104 { background-color: #8787d7; }
.ef105 { color: #8787ff; } .eb105 { background-color: #8787ff; }
.ef106 { color: #87af00; } .eb106 { background-color: #87af00; }
.ef107 { color: #87af5f; } .eb107 { background-color: #87af5f; }
.ef108 { color: #87af87; } .eb108 { background-color: #87af87; }
.ef109 { color: #87afaf; } .eb109 { background-color: #87afaf; }
.ef110 { color: #87afd7; } .eb110 { background-color: #87afd7; }
.ef111 { color: #87afff; } .eb111 { background-color: #87afff; }
.ef112 { color: #87d700; } .eb112 { background-color: #87d700; }
.ef113 { color: #87d75f; } .eb113 { background-color: #87d75f; }
.ef114 { color: #87d787; } .eb114 { background-color: #87d787; }
.ef115 { color: #87d7af; } .eb115 { background-color: #87d7af; }
.ef116 { color: #87d7d7; } .eb116 { background-color: #87d7d7; }
.ef117 { color: #87d7ff; } .eb117 { background-color: #87d7ff; }
.ef118 { color: #87ff00; } .eb118 { background-color: #87ff00; }
.ef119 { color: #87ff5f; } .eb119 { background-color: #87ff5f; }
.ef120 { color: #87ff87; } .eb120 { background-color: #87ff87; }
.ef121 { color: #87ffaf; } .eb121 { background-color: #87ffaf; }
.ef122 { color: #87ffd7; } .eb122 { background-color: #87ffd7; }
.ef123 { color: #87ffff; } .eb123 { background-color: #87ffff; }
.ef124 { color: #af0000; } .eb124 { background-color: #af0000; }
.ef125 { color: #af005f; } .eb125 { background-color: #af005f; }
.ef126 { color: #af0087; } .eb126 { background-color: #af0087; }
.ef127 { color: #af00af; } .eb127 { background-color: #af00af; }
.ef128 { color: #af00d7; } .eb128 { background-color: #af00d7; }
.ef129 { color: #af00ff; } .eb129 { background-color: #af00ff; }
.ef130 { color: #af5f00; } .eb130 { background-color: #af5f00; }
.ef131 { color: #af5f5f; } .eb131 { background-color: #af5f5f; }
.ef132 { color: #af5f87; } .eb132 { background-color: #af5f87; }
.ef133 { color: #af5faf; } .eb133 { background-color: #af5faf; }
.ef134 { color: #af5fd7; } .eb134 { background-color: #af5fd7; }
.ef135 { color: #af5fff; } .eb135 { background-color: #af5fff; }
.ef136 { color: #af8700; } .eb136 { background-color: #af8700; }
.ef137 { color: #af875f; } .eb137 { background-color: #af875f; }
.ef138 { color: #af8787; } .eb138 { background-color: #af8787; }
.ef139 { color: #af87af; } .eb139 { background-color: #af87af; }
.ef140 { color: #af87d7; } .eb140 { background-color: #af87d7; }
.ef141 { color: #af87ff; } .eb141 { background-color: #af87ff; }
.ef142 { color: #afaf00; } .eb142 { background-color: #afaf00; }
.ef143 { color: #afaf5f; } .eb143 { background-color: #afaf5f; }
.ef144 { color: #afaf87; } .eb144 { background-color: #afaf87; }
.ef145 { color: #afafaf; } .eb145 { background-color: #afafaf; }
.ef146 { color: #afafd7; } .eb146 { background-color: #afafd7; }
.ef147 { color: #afafff; } .eb147 { background-color: #afafff; }
.ef148 { color: #afd700; } .eb148 { background-color: #afd700; }
.ef149 { color: #afd75f; } .eb149 { background-color: #afd75f; }
.ef150 { color: #afd787; } .eb150 { background-color: #afd787; }
.ef151 { color: #afd7af; } .eb151 { background-color: #afd7af; }
.ef152 { color: #afd7d7; } .eb152 { background-color: #afd7d7; }
.ef153 { color: #afd7ff; } .eb153 { background-color: #afd7ff; }
.ef154 { color: #afff00; } .eb154 { background-color: #afff00; }
.ef155 { color: #afff5f; } .eb155 { background-color: #afff5f; }
.ef156 { color: #afff87; } .eb156 { background-color: #afff87; }
.ef157 { color: #afffaf; } .eb157 { background-color: #afffaf; }
.ef158 { color: #afffd7; } .eb158 { background-color: #afffd7; }
.ef159 { color: #afffff; } .eb159 { background-color: #afffff; }
.ef160 { color: #d70000; } .eb160 { background-color: #d70000; }
.ef161 { color: #d7005f; } .eb161 { background-color: #d7005f; }
.ef162 { color: #d70087; } .eb162 { background-color: #d70087; }
.ef163 { color: #d700af; } .eb163 { background-color: #d700af; }
.ef164 { color: #d700d7; } .eb164 { background-color: #d700d7; }
.ef165 { color: #d700ff; } .eb165 { background-color: #d700ff; }
.ef166 { color: #d75f00; } .eb166 { background-color: #d75f00; }
.ef167 { color: #d75f5f; } .eb167 { background-color: #d75f5f; }
.ef168 { color: #d75f87; } .eb168 { background-color: #d75f87; }
.ef169 { color: #d75faf; } .eb169 { background-color: #d75faf; }
.ef170 { color: #d75fd7; } .eb170 { background-color: #d75fd7; }
.ef171 { color: #d75fff; } .eb171 { background-color: #d75fff; }
.ef172 { color: #d78700; } .eb172 { background-color: #d78700; }
.ef173 { color: #d7875f; } .eb173 { background-color: #d7875f; }
.ef174 { color: #d78787; } .eb174 { background-color: #d78787; }
.ef175 { color: #d787af; } .eb175 { background-color: #d787af; }
.ef176 { color: #d787d7; } .eb176 { background-color: #d787d7; }
.ef177 { color: #d787ff; } .eb177 { background-color: #d787ff; }
.ef178 { color: #d7af00; } .eb178 { background-color: #d7af00; }
.ef179 { color: #d7af5f; } .eb179 { background-color: #d7af5f; }
.ef180 { color: #d7af87; } .eb180 { background-color: #d7af87; }
.ef181 { color: #d7afaf; } .eb181 { background-color: #d7afaf; }
.ef182 { color: #d7afd7; } .eb182 { background-color: #d7afd7; }
.ef183 { color: #d7afff; } .eb183 { background-color: #d7afff; }
.ef184 { color: #d7d700; } .eb184 { background-color: #d7d700; }
.ef185 { color: #d7d75f; } .eb185 { background-color: #d7d75f; }
.ef186 { color: #d7d787; } .eb186 { background-color: #d7d787; }
.ef187 { color: #d7d7af; } .eb187 { background-color: #d7d7af; }
.ef188 { color: #d7d7d7; } .eb188 { background-color: #d7d7d7; }
.ef189 { color: #d7d7ff; } .eb189 { background-color: #d7d7ff; }
.ef190 { color: #d7ff00; } .eb190 { background-color: #d7ff00; }
.ef191 { color: #d7ff5f; } .eb191 { background-color: #d7ff5f; }
.ef192 { color: #d7ff87; } .eb192 { background-color: #d7ff87; }
.ef193 { color: #d7ffaf; } .eb193 { background-color: #d7ffaf; }
.ef194 { color: #d7ffd7; } .eb194 { background-color: #d7ffd7; }
.ef195 { color: #d7ffff; } .eb195 { background-color: #d7ffff; }
.ef196 { color: #ff0000; } .eb196 { background-color: #ff0000; }
.ef197 { color: #ff005f; } .eb197 { background-color: #ff005f; }
.ef198 { color: #ff0087; } .eb198 { background-color: #ff0087; }
.ef199 { color: #ff00af; } .eb199 { background-color: #ff00af; }
.ef200 { color: #ff00d7; } .eb200 { background-color: #ff00d7; }
.ef201 { color: #ff00ff; } .eb201 { background-color: #ff00ff; }
.ef202 { color: #ff5f00; } .eb202 { background-color: #ff5f00; }
.ef203 { color: #ff5f5f; } .eb203 { background-color: #ff5f5f; }
.ef204 { color: #ff5f87; } .eb204 { background-color: #ff5f87; }
.ef205 { color: #ff5faf; } .eb205 { background-color: #ff5faf; }
.ef206 { color: #ff5fd7; } .eb206 { background-color: #ff5fd7; }
.ef207 { color: #ff5fff; } .eb207 { background-color: #ff5fff; }
.ef208 { color: #ff8700; } .eb208 { background-color: #ff8700; }
.ef209 { color: #ff875f; } .eb209 { background-color: #ff875f; }
.ef210 { color: #ff8787; } .eb210 { background-color: #ff8787; }
.ef211 { color: #ff87af; } .eb211 { background-color: #ff87af; }
.ef212 { color: #ff87d7; } .eb212 { background-color: #ff87d7; }
.ef213 { color: #ff87ff; } .eb213 { background-color: #ff87ff; }
.ef214 { color: #ffaf00; } .eb214 { background-color: #ffaf00; }
.ef215 { color: #ffaf5f; } .eb215 { background-color: #ffaf5f; }
.ef216 { color: #ffaf87; } .eb216 { background-color: #ffaf87; }
.ef217 { color: #ffafaf; } .eb217 { background-color: #ffafaf; }
.ef218 { color: #ffafd7; } .eb218 { background-color: #ffafd7; }
.ef219 { color: #ffafff; } .eb219 { background-color: #ffafff; }
.ef220 { color: #ffd700; } .eb220 { background-color: #ffd700; }
.ef221 { color: #ffd75f; } .eb221 { background-color: #ffd75f; }
.ef222 { color: #ffd787; } .eb222 { background-color: #ffd787; }
.ef223 { color: #ffd7af; } .eb223 { background-color: #ffd7af; }
.ef224 { color: #ffd7d7; } .eb224 { background-color: #ffd7d7; }
.ef225 { color: #ffd7ff; } .eb225 { background-color: #ffd7ff; }
.ef226 { color: #ffff00; } .eb226 { background-color: #ffff00; }
.ef227 { color: #ffff5f; } .eb227 { background-color: #ffff5f; }
.ef228 { color: #ffff87; } .eb228 { background-color: #ffff87; }
.ef229 { color: #ffffaf; } .eb229 { background-color: #ffffaf; }
.ef230 { color: #ffffd7; } .eb230 { background-color: #ffffd7; }
.ef231 { color: #ffffff; } .eb231 { background-color: #ffffff; }
.ef232 { color: #080808; } .eb232 { background-color: #080808; }
.ef233 { color: #121212; } .eb233 { background-color: #121212; }
.ef234 { color: #1c1c1c; } .eb234 { background-color: #1c1c1c; }
.ef235 { color: #262626; } .eb235 { background-color: #262626; }
.ef236 { color: #303030; } .eb236 { background-color: #303030; }
.ef237 { color: #3a3a3a; } .eb237 { background-color: #3a3a3a; }
.ef238 { color: #444444; } .eb238 { background-color: #444444; }
.ef239 { color: #4e4e4e; } .eb239 { background-color: #4e4e4e; }
.ef240 { color: #585858; } .eb240 { background-color: #585858; }
.ef241 { color: #626262; } .eb241 { background-color: #626262; }
.ef242 { color: #6c6c6c; } .eb242 { background-color: #6c6c6c; }
.ef243 { color: #767676; } .eb243 { background-color: #767676; }
.ef244 { color: #808080; } .eb244 { background-color: #808080; }
.ef245 { color: #8a8a8a; } .eb245 { background-color: #8a8a8a; }
.ef246 { color: #949494; } .eb246 { background-color: #949494; }
.ef247 { color: #9e9e9e; } .eb247 { background-color: #9e9e9e; }
.ef248 { color: #a8a8a8; } .eb248 { background-color: #a8a8a8; }
.ef249 { color: #b2b2b2; } .eb249 { background-color: #b2b2b2; }
.ef250 { color: #bcbcbc; } .eb250 { background-color: #bcbcbc; }
.ef251 { color: #c6c6c6; } .eb251 { background-color: #c6c6c6; }
.ef252 { color: #d0d0d0; } .eb252 { background-color: #d0d0d0; }
.ef253 { color: #dadada; } .eb253 { background-color: #dadada; }
.ef254 { color: #e4e4e4; } .eb254 { background-color: #e4e4e4; }
.ef255 { color: #eeeeee; } .eb255 { background-color: #eeeeee; }

.f9 { color: #000000; }
.b9 { background-color: #FFFFFF; }
.f9 > .bold,.bold > .f9, body.f9 > pre > .bold {
  /* Bold is heavy black on white, or bright white
     depending on the default background */
  color: #5555FF;
  font-weight: bold;
}
.reverse {
  /* CSS does not support swapping fg and bg colours unfortunately,
     so just hardcode something that will look OK on all backgrounds. */
  color: #000000; background-color: #AAAAAA;
}
.underline { text-decoration: underline; }
.line-through { text-decoration: line-through; }
.blink { text-decoration: blink; }

/* Avoid pixels between adjacent span elements.
   Note this only works for lines less than 80 chars
   where we close span elements on the same line.
span { display: inline-block; }
*/
</style>
</head>

<body class="f9 b9">
<h1>说明：</h1>
<ul>
	<li>
		<p>
			本Demo使用的是
			<a href="https://coding.net/u/Gotye/p/ios.demo/git">亲加2015-10-21发布的版本</a>
		</p>
	</li>
	<li>
		<p>
			本Demo在亲加官方Demo的基础上集成了BQMM,在修改的地方我们都加上了“BQMM集成"的注释，可在项目中全局搜索查看
		</p>
	</li>
	<li>
		<p>
			我们提供了集成之后的Demo与官方Demo的Diff文档,供大家查看 (绿色为新增的代码，红色为删除的代码)
		</p>
	</li>
</ul>


<h1>
	集成之后的Demo与官方Demo的Diff文档：
</h1>
<pre>
<span class="bold">diff --git a/GotyeIM/GotyeAPI/GotyeOCMessage.h b/GotyeIM/GotyeAPI/GotyeOCMessage.h</span>
<span class="bold">index 92f99f6..4fb8350 100644</span>
<span class="bold">--- a/GotyeIM/GotyeAPI/GotyeOCMessage.h</span>
<span class="bold">+++ b/GotyeIM/GotyeAPI/GotyeOCMessage.h</span>
<span class="f6">@@ -48,7 +48,10 @@</span> typedef enum
@property(nonatomic, assign) unsigned date;         ///&lt;  时间(自1970/1/1 00:00:00所经历的毫秒数)
@property(nonatomic, assign) long long dbID;        ///&lt; 本地数据库id
@property(nonatomic, copy) NSString* text;          ///&lt; 文本内容
<span class="f2">//BQMM集成<br/>@property(nonatomic, copy) NSString* extraText;          ///&lt; 附加字段的文本内容</span>

@property(nonatomic, retain) GotyeOCMedia* media;   ///&lt; 语音/图片/用户自定义数据
<span class="f2">//BQMM集成  添加消息消息扩展字段</span>
@property(nonatomic, retain) GotyeOCMedia* extra;   ///&lt; 消息附加数据

@property(nonatomic, assign) GotyeMessageType type;         ///&lt; 消息类型
<span class="f6">@@ -178,7 +181,8 @@</span> typedef enum
 * @param data: 数据指针
 * @param len: 数据长度
 */
<span class="f2">//BQMM集成</span>
-(void)putExtraData:(const void*) data  <span class="f1">len:(unsigned)len;</span><span class="f2">len:(unsigned)len;//此接口改为直接赋值给extraText</span>

/**
 * @brief 添加附加数据文件
<span class="bold">diff --git a/GotyeIM/GotyeAppDelegate.mm b/GotyeIM/GotyeAppDelegate.mm</span>
<span class="bold">index 18f48f6..456cbb1 100644</span>
<span class="bold">--- a/GotyeIM/GotyeAppDelegate.mm</span>
<span class="bold">+++ b/GotyeIM/GotyeAppDelegate.mm</span>
<span class="f6">@@ -12,10 +12,12 @@</span>
#import &quot;GotyeUIUtil.h&quot;
#import &quot;GotyeOCAPI.h&quot;

<span class="f2">//BQMM集成  引入头文件</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

#define DEFAULT_APPKEY      (@&quot;<span class="f2">0835b16b-1981-4e56-af09-72ce8aca5c5d&quot;)//*/(@&quot;</span>9c236035-2bf4-40b0-bfbf-e8b6dec54928&quot;)

void set_login_config(const char* server, int port);
<span class="f1">int gotye_download_audio(const char* url);</span>

@implementation GotyeAppDelegate

<span class="f6">@@ -76,6 +78,9 @@</span> - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(
#endif

    [self.window makeKeyAndVisible];
    <span class="f2">//BQMM集成  初始化BQMM</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] setAppId:@&quot;YourAppId&quot;</span>
<span class="f2">                                       secret:@&quot;YourAppSecret&quot;];</span>

    return YES;
}
<span class="f6">@@ -119,6 +124,7 @@</span> - (void)applicationDidEnterBackground:(UIApplication *)application
- (void)applicationWillEnterForeground:(UIApplication *)application
{
    // Called as part of the transition from the background to the inactive state; here you can undo many of the changes made on entering the background.
    <span class="f2">//BQMM集成 <br/>[[MMEmotionCentre defaultCentre] clearSession];</span>
}

- (void)applicationDidBecomeActive:(UIApplication *)application
<span class="f6">@@ -126,6 +132,10 @@</span> - (void)applicationDidBecomeActive:(UIApplication *)application
    // Restart any tasks that were paused (or not yet started) while the application was inactive. If the application was previously in the background, optionally refresh the user interface.

    self.navController.view.userInteractionEnabled = YES;
    <span class="f2">//BQMM集成</span>
<span class="f2">    [[NSNotificationCenter defaultCenter] postNotificationName:@&quot;Foreground&quot;</span>
<span class="f2">                                                        object:self</span>
<span class="f2">                                                      userInfo:nil];</span>
}

- (void)applicationWillTerminate:(UIApplication *)application
<span class="bold">diff --git a/GotyeIM/GotyeIM-Info.plist b/GotyeIM/GotyeIM-Info.plist</span>
<span class="bold">index b85043f..5e40b5f 100644</span>
<span class="bold">--- a/GotyeIM/GotyeIM-Info.plist</span>
<span class="bold">+++ b/GotyeIM/GotyeIM-Info.plist</span>
<span class="f6">@@ -8,8 +8,10 @@</span>
	&lt;string&gt;${PRODUCT_NAME}&lt;/string&gt;
	&lt;key&gt;CFBundleExecutable&lt;/key&gt;
	&lt;string&gt;${EXECUTABLE_NAME}&lt;/string&gt;
	<span class="f2">&lt;key&gt;CFBundleGetInfoString&lt;/key&gt;</span>
<span class="f2">	&lt;string&gt;&lt;/string&gt;</span>
	&lt;key&gt;CFBundleIdentifier&lt;/key&gt;
	<span class="f1">&lt;string&gt;com.gotye.api.ios.im&lt;/string&gt;</span><span class="f2">&lt;string&gt;$(PRODUCT_BUNDLE_IDENTIFIER)&lt;/string&gt;</span>
	&lt;key&gt;CFBundleInfoDictionaryVersion&lt;/key&gt;
	&lt;string&gt;6.0&lt;/string&gt;
	&lt;key&gt;CFBundleName&lt;/key&gt;
<span class="f6">@@ -22,8 +24,15 @@</span>
	&lt;string&gt;????&lt;/string&gt;
	&lt;key&gt;CFBundleVersion&lt;/key&gt;
	&lt;string&gt;1.0&lt;/string&gt;
	<span class="f2">&lt;key&gt;LSApplicationCategoryType&lt;/key&gt;</span>
<span class="f2">	&lt;string&gt;&lt;/string&gt;</span>
	&lt;key&gt;LSRequiresIPhoneOS&lt;/key&gt;
	&lt;true/&gt;
	<span class="f2">&lt;key&gt;NSAppTransportSecurity&lt;/key&gt;</span>
<span class="f2">	&lt;dict&gt;</span>
<span class="f2">		&lt;key&gt;NSAllowsArbitraryLoads&lt;/key&gt;</span>
<span class="f2">		&lt;true/&gt;</span>
<span class="f2">	&lt;/dict&gt;</span>
	&lt;key&gt;UIRequiredDeviceCapabilities&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;armv7&lt;/string&gt;
<span class="bold">diff --git a/GotyeIM/UI/ChatView/GotyeChatBubbleView.h b/GotyeIM/UI/ChatView/GotyeChatBubbleView.h</span>
<span class="bold">index 7952a4b..fead08d 100644</span>
<span class="bold">--- a/GotyeIM/UI/ChatView/GotyeChatBubbleView.h</span>
<span class="bold">+++ b/GotyeIM/UI/ChatView/GotyeChatBubbleView.h</span>
<span class="f6">@@ -18,8 +18,9 @@</span>
#define bubbleThumbImageTag     10002
#define bubbleMessageButtonTag  10003

<span class="f2">//BQMM集成</span>
+(NSInteger)getbubbleHeight:(GotyeOCMessage*)message <span class="f2">target:(GotyeOCChatTarget*)chatTarget</span> showDate:(BOOL)showDate;

+(UIView*)BubbleWithMessage:(GotyeOCMessage*)message <span class="f2">target:(GotyeOCChatTarget*)chatTarget</span> showDate:(BOOL)showDate;

@end
<span class="bold">diff --git a/GotyeIM/UI/ChatView/GotyeChatBubbleView.m b/GotyeIM/UI/ChatView/GotyeChatBubbleView.m</span>
<span class="bold">index 154fe70..ad331c3 100644</span>
<span class="bold">--- a/GotyeIM/UI/ChatView/GotyeChatBubbleView.m</span>
<span class="bold">+++ b/GotyeIM/UI/ChatView/GotyeChatBubbleView.m</span>
<span class="f6">@@ -10,6 +10,13 @@</span>

#import &quot;GotyeUIUtil.h&quot;

<span class="f2">#import &quot;GotyeSettingManager.h&quot;</span>

<span class="f2">//BQMM集成  引入头文件</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>
<span class="f2">#import &quot;MMTextParser+ExtData.h&quot;</span>

#define kContentWidthMax    160
#define kBubbleMinHeight    40
#define kHeadIconSize       40
<span class="f6">@@ -28,17 +35,33 @@</span>

@implementation GotyeChatBubbleView

<span class="f2">//BQMM集成  重新计算bubbleHeight</span>
+(NSInteger)getbubbleHeight:(GotyeOCMessage*)message <span class="f2">target:(GotyeOCChatTarget*)chatTarget</span> showDate:(BOOL)showDate
{
    UIFont *font = [UIFont systemFontOfSize:kTextFontSize];
    CGSize size;

    <span class="f2">NSString *extStr = [[NSString alloc] initWithData:message.getExtraData encoding:NSUTF8StringEncoding];</span>
<span class="f2">    NSDictionary *ext = [NSJSONSerialization JSONObjectWithData:[extStr dataUsingEncoding:NSUTF8StringEncoding] options:NSJSONReadingMutableContainers error:nil];</span>

    switch (message.type) {
        case GotyeMessageTypeText:
        {
            <span class="f1">size</span><span class="f2">NSString *txt_msgType</span> = <span class="f2">ext</span>[<span class="f1">message.text boundingRectWithSize:CGSizeMake</span><span class="f2">@&quot;txt_msgType&quot;];</span>
<span class="f2">            if</span> (<span class="f1">kContentWidthMax, 1000.0f</span><span class="f2">txt_msgType</span>) <span class="f1">options:NSStringDrawingUsesLineFragmentOrigin</span>
<span class="f1">                                   attributes</span><span class="f2">{</span>
<span class="f2">                //图文混排</span>
<span class="f2">                if ([txt_msgType isEqualToString</span>:@<span class="f2">&quot;emojitype&quot;])</span> {
                    <span class="f1">NSFontAttributeName</span><span class="f2">size = [MMTextParser sizeForMMTextWithExtData:ext[@&quot;msg_data&quot;] font</span>:font <span class="f2">maximumTextWidth:kContentWidthMax];</span>
                }
                <span class="f1">context</span><span class="f2">//大表情</span>
<span class="f2">                else if ([txt_msgType isEqualToString</span>:<span class="f1">nil</span><span class="f2">@&quot;facetype&quot;</span>]<span class="f1">.</span><span class="f2">) {</span>
                    size <span class="f2">= CGSizeMake(120, 120)</span>;
                <span class="f2">}</span>
<span class="f2">            }</span>
<span class="f2">            //纯文字</span>
<span class="f2">            else {</span>
<span class="f2">                size = [MMTextParser sizeForTextWithText:message.text font:font maximumTextWidth:kContentWidthMax];</span>
<span class="f2">            }</span>
        }
            break;
        case GotyeMessageTypeAudio:
<span class="f6">@@ -78,8 +101,8 @@</span> +(NSInteger)getbubbleHeight:(GotyeOCMessage*)message showDate:(BOOL)showDate
    return size.height + kGapBetweenBubbles;
}

<span class="f2">//BQMM集成  设置bubbleView</span>
+(UIView*)BubbleWithMessage:(GotyeOCMessage*)message  <span class="f2">target:(GotyeOCChatTarget*)chatTarget</span> showDate:(BOOL)showDate
{
    NSString *text = message.text;
    GotyeMessageType msgType = message.type;
<span class="f6">@@ -114,31 +137,85 @@</span> +(UIView*)BubbleWithMessage:(GotyeOCMessage*)message  showDate:(BOOL)showDate
    CGSize size;
    UIView *content = nil, *content2 = nil;

    <span class="f2">NSString *extStr = [[NSString alloc] initWithData:message.getExtraData encoding:NSUTF8StringEncoding];</span>
<span class="f2">    NSDictionary *ext = [NSJSONSerialization JSONObjectWithData:[extStr dataUsingEncoding:NSUTF8StringEncoding] options:NSJSONReadingMutableContainers error:nil];</span>
<span class="f2">    </span>
<span class="f2">    NSString *txt_msgType = ext[@&quot;txt_msgType&quot;];</span>

    switch (msgType) {
        case GotyeMessageTypeText:
        {
            <span class="f2">if (txt_msgType) {</span>
                //<span class="f2">图</span>文<span class="f1">字标签设置</span><span class="f2">混排</span>
<span class="f2">                if ([txt_msgType isEqualToString:@&quot;emojitype&quot;]) {</span>
                    UIFont *font = [UIFont systemFontOfSize:kTextFontSize];
                    size = [<span class="f1">text boundingRectWithSize:CGSizeMake(kContentWidthMax, 1000.0f)</span>
<span class="f1">                               options:NSStringDrawingUsesLineFragmentOrigin</span>
<span class="f1">                            attributes</span><span class="f2">MMTextParser sizeForMMTextWithExtData</span>:<span class="f2">ext[</span>@<span class="f1">{NSFontAttributeName</span><span class="f2">&quot;msg_data&quot;] font</span>:font <span class="f1">}</span>
<span class="f1">                               context</span><span class="f2">maximumTextWidth</span>:<span class="f1">nil</span><span class="f2">kContentWidthMax</span>]<span class="f2">;</span>
<span class="f2">                    </span>
<span class="f2">                    if(msgFromSelf)</span>
<span class="f2">                    {</span>
<span class="f2">                        messageXoffset = ScreenWidth - messageXoffset - size</span>.<span class="f2">width;</span>
<span class="f2">                        bubbleXoffset = ScreenWidth - bubbleXoffset - kBubbleCommaGap - kBubbleEndGap -</span> size<span class="f2">.width</span>;
                    <span class="f2">}</span>

                    <span class="f2">MMTextView *bubbleText = [[MMTextView alloc] initWithFrame:CGRectMake(messageXoffset, kGapBetweenBubbles / 2 + kBubbleTopGap + messageYoffset, size.width, size.height)];</span>
<span class="f2">                    bubbleText.backgroundColor = [UIColor clearColor];</span>
<span class="f2">                    bubbleText.mmFont = font;</span>
<span class="f2">                    [bubbleText setMmTextData:ext[@&quot;msg_data&quot;]];</span>
<span class="f2">                    </span>
<span class="f2">                    content = bubbleText;</span>
<span class="f2">                }</span>
<span class="f2">                //大表情</span>
<span class="f2">                else if ([txt_msgType isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">                    size = CGSizeMake(120, 120);</span>
<span class="f2">                    </span>
<span class="f2">                    if(msgFromSelf)</span>
<span class="f2">                    {</span>
<span class="f2">                        messageXoffset = ScreenWidth - messageXoffset - size.width;</span>
<span class="f2">                        bubbleXoffset = ScreenWidth - bubbleXoffset - kBubbleCommaGap - kBubbleEndGap - size.width;</span>
<span class="f2">                    }</span>
<span class="f2">                    </span>
<span class="f2">                    UIImageView *imgView = [[UIImageView alloc] initWithFrame:CGRectMake(messageXoffset, kGapBetweenBubbles / 2 + kBubbleTopGap + messageYoffset, size.width, size.height)];</span>
<span class="f2">                    imgView.image = [UIImage imageNamed:@&quot;chat_button_pic&quot;];</span>
<span class="f2">                    imgView.tag = bubbleThumbImageTag;</span>
<span class="f2">                    </span>
<span class="f2">                    content = imgView;</span>
<span class="f2">                    </span>
<span class="f2">                    NSArray *codes = @[ext[@&quot;msg_data&quot;][0][0]];</span>
<span class="f2">                    [[MMEmotionCentre defaultCentre] fetchEmojisByType:MMFetchTypeBig codes:codes completionHandler:^(NSArray *emojis) {</span>
<span class="f2">                        if (emojis.count &gt; 0) {</span>
<span class="f2">                            MMEmoji *emoji = emojis[0];</span>
<span class="f2">                            if ([ext[@&quot;msg_data&quot;][0][0] isEqualToString:emoji.emojiCode]) {</span>
<span class="f2">                                imgView.image = emoji.emojiImage;</span>
<span class="f2">                            }</span>
<span class="f2">                        }</span>
<span class="f2">                        else {</span>
<span class="f2">                            imgView.image = [UIImage imageNamed:@&quot;chat_button_pic&quot;];</span>
<span class="f2">                        }</span>
<span class="f2">                    }];</span>
<span class="f2">                    bubbleImageView.hidden = YES;</span>
<span class="f2">                }</span>
<span class="f2">            }</span>
<span class="f2">            //纯文字</span>
<span class="f2">            else {</span>
<span class="f2">                UIFont *font = [UIFont systemFontOfSize:kTextFontSize];</span>
<span class="f2">                size = [MMTextParser sizeForTextWithText:text font:font maximumTextWidth:kContentWidthMax];</span>

                if(msgFromSelf)
                {
                    messageXoffset = ScreenWidth - messageXoffset - size.width;
                    bubbleXoffset = ScreenWidth - bubbleXoffset - kBubbleCommaGap - kBubbleEndGap - size.width;
                <span class="f2">}</span>
<span class="f2">                </span>
<span class="f2">                UILabel *bubbleText = [[UILabel alloc] initWithFrame:CGRectMake(messageXoffset, kGapBetweenBubbles / 2 + kBubbleTopGap + messageYoffset, size.width, size.height)];</span>
<span class="f2">                bubbleText.backgroundColor = [UIColor clearColor];</span>
<span class="f2">                bubbleText.textColor = textColor;</span>
<span class="f2">                bubbleText.font = font;</span>
<span class="f2">                bubbleText.numberOfLines = 0;</span>
<span class="f2">                bubbleText.lineBreakMode = NSLineBreakByWordWrapping;</span>
<span class="f2">                bubbleText.text = text;</span>
<span class="f2">                </span>
<span class="f2">                content = bubbleText;</span>
            }
<span class="f1">            </span>
<span class="f1">            UILabel *bubbleText = [[UILabel alloc] initWithFrame:CGRectMake(messageXoffset, kGapBetweenBubbles / 2 + kBubbleTopGap + messageYoffset, size.width, size.height)];</span>
<span class="f1">            bubbleText.backgroundColor = [UIColor clearColor];</span>
<span class="f1">            bubbleText.textColor = textColor;</span>
<span class="f1">            bubbleText.font = font;</span>
<span class="f1">            bubbleText.numberOfLines = 0;</span>
<span class="f1">            bubbleText.lineBreakMode = NSLineBreakByWordWrapping;</span>
<span class="f1">            bubbleText.text = text;</span>
<span class="f1">            </span>
<span class="f1">            content = bubbleText;</span>
        }
            break;

<span class="f6">@@ -160,7 +237,7 @@</span> +(UIView*)BubbleWithMessage:(GotyeOCMessage*)message  showDate:(BOOL)showDate
            durText.textAlignment = msgFromSelf ? NSTextAlignmentLeft : NSTextAlignmentRight;

            NSInteger sec = message.media.duration &lt; 1000 ? 1: message.media.duration /1000;
            durText.text = [[NSString alloc] initWithFormat:@&quot;%<span class="f1">d</span><span class="f2">ld</span>\&quot;&quot;, <span class="f2">(long)</span>sec];

            UIImageView *voiceImage = [[UIImageView alloc] initWithFrame:CGRectMake(messageXoffset + (msgFromSelf ? size.width - 16 : 0), kGapBetweenBubbles / 2 + 10 + messageYoffset, 14, 20)];

<span class="f6">@@ -231,13 +308,14 @@</span> +(UIView*)BubbleWithMessage:(GotyeOCMessage*)message  showDate:(BOOL)showDate

	bubbleImageView.frame = CGRectMake(bubbleXoffset, kGapBetweenBubbles / 2 + messageYoffset, size.width + kBubbleCommaGap + kBubbleEndGap, size.height + kBubbleTopGap + kBubbleEndGap);

	messageView.frame = CGRectMake(0.0f, 0.0f, <span class="f1">320</span><span class="f2">ScreenWidth</span>, bubbleImageView.frame.size.height + <span class="f2">2*</span>kGapBetweenBubbles + messageYoffset);
	[messageView addSubview:bubbleImageView];
    [messageView addSubview:content];
    [messageView addSubview:content2];

//  热点按钮
    if(<span class="f1">message.type</span><span class="f2">msgType</span> == GotyeMessageTypeAudio || <span class="f1">message.type</span><span class="f2">msgType</span> == GotyeMessageTypeImage
       <span class="f2">|| (msgType == GotyeMessageTypeText &amp;&amp; [txt_msgType isEqualToString:@&quot;facetype&quot;])</span>)
    {
        UIButton *msgButton = [[UIButton alloc] initWithFrame:bubbleImageView.frame];
        msgButton.tag = bubbleMessageButtonTag;
<span class="f6">@@ -253,20 +331,34 @@</span> +(UIView*)BubbleWithMessage:(GotyeOCMessage*)message  showDate:(BOOL)showDate
    headImageView.tag = bubbleHeadButtonTag;
    if(msgFromSelf)
    {
        headImageView.frame = CGRectMake(<span class="f1">265</span><span class="f2">ScreenWidth - 55</span>, <span class="f2">/*</span>kGapBetweenBubbles / 2 + <span class="f2">*/</span>messageYoffset, kHeadIconSize, kHeadIconSize);
    }
    else
    {
        headImageView.frame = CGRectMake(15, <span class="f2">/*</span>kGapBetweenBubbles / 2 + <span class="f2">*/</span>messageYoffset, kHeadIconSize, kHeadIconSize);
    }
    [headImageView setBackgroundImage:headImage forState:UIControlStateNormal];

    [messageView addSubview:headImageView];

<span class="f2">//  用户名</span>
<span class="f2">    NSDictionary *dic = [NSDictionary dictionary];</span>
<span class="f2">    dic = [[GotyeSettingManager defaultManager] getSetting:chatTarget.type targetID:[NSString stringWithFormat:@&quot;%lld&quot;, chatTarget.id]];</span>
<span class="f2">    if ([dic[Setting_key_NickName] boolValue]) {</span>
<span class="f2">        </span>
<span class="f2">        UILabel *nameLabel = [[UILabel alloc] initWithFrame:CGRectMake(headImageView.frame.origin.x, kHeadIconSize+messageYoffset, kHeadIconSize, kGapBetweenBubbles)];</span>
<span class="f2">        nameLabel.text = message.sender.name;</span>
<span class="f2">        nameLabel.font = [UIFont systemFontOfSize:11];</span>
<span class="f2">        nameLabel.backgroundColor = [UIColor clearColor];</span>
<span class="f2">        nameLabel.textColor = [UIColor lightGrayColor];</span>
<span class="f2">        [messageView addSubview:nameLabel];</span>
<span class="f2">    }else {</span>
<span class="f2">        </span>
<span class="f2">    }</span>
//  时间
    if(showDate)
    {
        UILabel *dateText = [[UILabel alloc] initWithFrame:CGRectMake(0, kGapBetweenBubbles / 2, <span class="f1">320</span><span class="f2">ScreenWidth</span>, kDateTextHeight)];
        dateText.backgroundColor = [UIColor clearColor];
        dateText.textColor = [UIColor lightGrayColor];
        dateText.font = [UIFont systemFontOfSize:11];
<span class="f6">@@ -310,7 +402,7 @@</span> +(UIView*)BubbleWithMessage:(GotyeOCMessage*)message  showDate:(BOOL)showDate
        [messageView addSubview:stateText];
    }

    if(message.hasExtraData &amp;&amp; <span class="f1">message.type</span><span class="f2">msgType</span> == GotyeMessageTypeAudio)
    {
        NSData *data = [message getExtraData];//[NSData dataWithContentsOfFile:message.extra.path];

<span class="f6">@@ -329,7 +421,8 @@</span> +(UIView*)BubbleWithMessage:(GotyeOCMessage*)message  showDate:(BOOL)showDate
            extraText.font = [UIFont systemFontOfSize:11];
            extraText.textAlignment = msgFromSelf ? NSTextAlignmentRight : NSTextAlignmentLeft;
            extraText.text = [NSString stringWithFormat:@&quot;语音内容：%@&quot;, extraStr];
            <span class="f2">extraText.text = [NSString stringWithFormat:@&quot;语音内容：%@&quot;, message.extraText];</span>

            [messageView addSubview:extraText];
        }
    }
<span class="bold">diff --git a/GotyeIM/UI/ChatView/GotyeChatViewController.h b/GotyeIM/UI/ChatView/GotyeChatViewController.h</span>
<span class="bold">index 190acb8..bbc7340 100644</span>
<span class="bold">--- a/GotyeIM/UI/ChatView/GotyeChatViewController.h</span>
<span class="bold">+++ b/GotyeIM/UI/ChatView/GotyeChatViewController.h</span>
<span class="f6">@@ -10,6 +10,7 @@</span>

#import &quot;GotyeOCAPI.h&quot;

<span class="f2">#import &lt;AVFoundation/AVFoundation.h&gt;</span>

@interface GotyeChatViewController : UIViewController

<span class="f6">@@ -19,7 +20,8 @@</span>
@property (strong, nonatomic) IBOutlet UIView *chatView;
@property (strong, nonatomic) IBOutlet UIView *inputView;

<span class="f2">//BQMM集成  更换控件，请修改相应的.xib</span>
@property (strong, nonatomic) IBOutlet <span class="f1">UITextField</span><span class="f2">UITextView</span> * textInput;

@property (strong, nonatomic) IBOutlet UIButton *buttonVoice;
@property (strong, nonatomic) IBOutlet UIButton *buttonWrite;
<span class="f6">@@ -33,6 +35,12 @@</span>

@property (strong, nonatomic) IBOutlet UIView *speakingView;

<span class="f2">//BQMM集成  添加表情等按钮，请修改相应的.xib</span>
<span class="f2">@property (strong, nonatomic) IBOutlet UIButton *buttonFace;</span>
<span class="f2">@property (strong, nonatomic) IBOutlet UIButton *buttonAdd;</span>

<span class="f2">@property(nonatomic, strong) IBOutlet NSLayoutConstraint *inputViewBottomLayout;</span>

-(id)initWithTarget:(GotyeOCChatTarget*)target;

@end
<span class="bold">diff --git a/GotyeIM/UI/ChatView/GotyeChatViewController.m b/GotyeIM/UI/ChatView/GotyeChatViewController.m</span>
<span class="bold">index 01a5226..9c46d50 100644</span>
<span class="bold">--- a/GotyeIM/UI/ChatView/GotyeChatViewController.m</span>
<span class="bold">+++ b/GotyeIM/UI/ChatView/GotyeChatViewController.m</span>
<span class="f6">@@ -21,12 +21,20 @@</span>
#import &quot;GotyeRealTimeVoiceController.h&quot;
#import &quot;GotyeUserInfoController.h&quot;

<span class="f2">#import &quot;GotyeChatTableViewCell.h&quot;</span>

<span class="f2">//BQMM集成  添加头文件</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
<span class="f2">#import &quot;MMTextParser+ExtData.h&quot;</span>
<span class="f2">#import &quot;JSON.h&quot;</span>

#define BD_API_KEY @&quot;oKUHg75KeH787zPesCSEAGPw&quot;
#define BD_SECRET_KEY @&quot;dIR5nZGZreIUZpfnMRmVDBbBDIGtZlLK&quot;

static GotyeChatViewController *chatViewRetainForBDVR = nil;

<span class="f2">//BQMM集成  添加delegate</span>
@interface GotyeChatViewController () &lt;GotyeOCDelegate, UITableViewDataSource, UITableViewDelegate, UIImagePickerControllerDelegate, UINavigationControllerDelegate<span class="f2">, MMEmotionCentreDelegate, UITextViewDelegate</span>&gt;
{
    GotyeOCChatTarget* chatTarget;

<span class="f6">@@ -34,9 +42,6 @@</span> @interface GotyeChatViewController () &lt;GotyeOCDelegate, UITableViewDataSource, U

    NSInteger playingRow;

<span class="f1">    CGFloat keyboardHeight;</span>
<span class="f1">    CGFloat chatViewOriginY;</span>
<span class="f1">    </span>
    UIButton *largeImageView;

    NSArray *messageList;
<span class="f6">@@ -47,13 +52,20 @@</span> @interface GotyeChatViewController () &lt;GotyeOCDelegate, UITableViewDataSource, U

    GotyeOCMessage *decodingMessage;
    //BDVRRawDataRecognizer *rawDataRecognizer;

    <span class="f2">//BQMM集成</span>
<span class="f2">    NSInteger _indexRow;</span>
<span class="f2">    </span>
<span class="f2">    BOOL hasscrollView;</span>

}

@end

@implementation GotyeChatViewController

<span class="f2">//BQMM集成</span>
@synthesize <span class="f2">tableView,</span> chatView, inputView, buttonVoice, buttonWrite, realtimeStartView, labelRealTimeStart, textInput, buttonRealTime, buttonSpeak, speakingView<span class="f2">, buttonFace, buttonAdd, inputViewBottomLayout</span>;

- (id)initWithTarget:(GotyeOCChatTarget*)target
{
<span class="f6">@@ -69,7 +81,6 @@</span> - (void)viewDidLoad
{
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
<span class="f1">    </span>
    switch (chatTarget.type) {
        case GotyeChatTargetTypeUser:
        {
<span class="f6">@@ -105,10 +116,14 @@</span> - (void)viewDidLoad
                                                      target:self
                                                      action:@selector(roomSettingClick:)];

            <span class="f2">//BQMM集成</span>
            GotyeOCRoom* room = [GotyeOCAPI getRoomDetail:chatTarget <span class="f2">forceRequest: NO</span>];
            self.navigationItem.title = room.name;
        }
            break;

        <span class="f2">default:</span>
<span class="f2">            break;</span>
    }

    messageList = [GotyeOCAPI getMessageList:chatTarget more:chatTarget.type==GotyeChatTargetTypeRoom];
<span class="f6">@@ -123,6 +138,15 @@</span> - (void)viewDidLoad
    speakingView.layer.cornerRadius = 20;
    speakingView.layer.masksToBounds = YES;
    speakingView.hidden = YES;

    <span class="f2">//BQMM集成  BQMM delegate设置和表情联想设置</span>
<span class="f2">    hasscrollView = YES;</span>
<span class="f2">    </span>
<span class="f2">    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(keyBoardHidden)];</span>
<span class="f2">    [self.view addGestureRecognizer:tap];</span>
<span class="f2">    </span>
<span class="f2">    [MMEmotionCentre defaultCentre].delegate = self;</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] shouldShowShotcutPopoverAboveView:buttonFace withInput:textInput];</span>
}

- (void)reloadHistorys:(BOOL)scrollToEnd
<span class="f6">@@ -141,8 +165,9 @@</span> - (void)viewWillAppear:(BOOL)animated
    [self.view addSubview:chatView];
    if(self.isMovingToParentViewController)
    {
        <span class="f2">//BQMM集成</span>
        chatView.frame = CGRectMake(0, self.view.frame.size.height - 50, <span class="f1">320</span><span class="f2">ScreenWidth</span>, 150);
        self.tableView.frame = CGRectMake(0, 0, <span class="f1">320</span><span class="f2">ScreenWidth</span>, chatView.frame.origin.y);

        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(exitChatProcesses) name:popToRootViewControllerNotification object:nil];
    }
<span class="f6">@@ -186,103 +211,141 @@</span> - (void)exitChatProcesses

    [GotyeOCAPI stopTalk];

<span class="f1">    //rawDataRecognizer.delegate = nil;</span>
<span class="f1">    </span>
    [[NSNotificationCenter defaultCenter] removeObserver:self];
}

<span class="f2">//BQMM集成  keyboard相关的修改 开始</span>
- (void)<span class="f1">keyboardWillShown:(NSNotification*)notify</span><span class="f2">keyBoardHidden</span>
{
<span class="f1">if(chatViewOriginY == 0)</span>
<span class="f1">        chatViewOriginY = chatView.frame.origin.y;</span>    [<span class="f1">self moveTextViewForKeyBoard:notify up</span><span class="f2">inputView endEditing</span>:YES];
    <span class="f2">[[MMEmotionCentre defaultCentre] switchToDefaultKeyboard];</span>
}

- (void)<span class="f1">keyboardWillHidden</span><span class="f2">keyboardWillShown</span>:(NSNotification*)notify
{
    <span class="f2">NSDictionary *userInfo = notify.userInfo;</span>
<span class="f2">    CGRect endFrame = [userInfo[UIKeyboardFrameEndUserInfoKey] CGRectValue];</span>
<span class="f2">    CGFloat duration = [userInfo[UIKeyboardAnimationDurationUserInfoKey] doubleValue];</span>
<span class="f2">    UIViewAnimationCurve curve = [userInfo</span>[<span class="f1">self moveTextViewForKeyBoard</span><span class="f2">UIKeyboardAnimationCurveUserInfoKey] integerValue];</span>
<span class="f2">    </span>
<span class="f2">    void(^animations)() = ^{</span>
<span class="f2">        inputViewBottomLayout.constant = endFrame.size.height - 100;</span>
<span class="f2">    };</span>
<span class="f2">    </span>
<span class="f2">    void(^completion)(BOOL) = ^(BOOL finished){</span>
<span class="f2">        if (messageList.count &gt; 0) {</span>
<span class="f2">            [tableView scrollToRowAtIndexPath</span>:<span class="f1">notify up</span><span class="f2">[NSIndexPath indexPathForItem:messageList.count-1 inSection:0] atScrollPosition:UITableViewScrollPositionBottom animated</span>:<span class="f1">NO</span><span class="f2">YES</span>];
        <span class="f2">}</span>
<span class="f2">    };</span>

    <span class="f1">keyboardHeight = 0;</span>
<span class="f1">    chatViewOriginY = 0</span><span class="f2">[UIView animateWithDuration:duration delay:0.0f options:(curve &lt;&lt; 16 | UIViewAnimationOptionBeginFromCurrentState) animations:animations completion:completion]</span>;
}

- (void)<span class="f1">moveTextViewForKeyBoard</span><span class="f2">keyboardWillHidden</span>:(NSNotification*)notify<span class="f1">up:(BOOL)up</span>
{
    NSDictionary *userInfo =<span class="f1">[</span> notify<span class="f2">.</span>userInfo<span class="f1">]</span>;
    <span class="f1">// Get animation info from userInfo</span>
<span class="f1">    NSTimeInterval animationDuration;</span>
<span class="f1">    UIViewAnimationCurve animationCurve;</span>
<span class="f1">    </span>
<span class="f1">    CGRect keyboardEndFrame;</span>
<span class="f1">    </span>
<span class="f1">    [</span><span class="f2">CGFloat duration =</span> [userInfo<span class="f1">objectForKey:UIKeyboardAnimationCurveUserInfoKey</span><span class="f2">[UIKeyboardAnimationDurationUserInfoKey</span>] <span class="f1">getValue:&amp;animationCurve</span><span class="f2">doubleValue</span>];
    <span class="f1">[</span><span class="f2">UIViewAnimationCurve curve =</span> [userInfo<span class="f1">objectForKey:UIKeyboardAnimationDurationUserInfoKey</span><span class="f2">[UIKeyboardAnimationCurveUserInfoKey</span>] <span class="f1">getValue:&amp;animationDuration</span><span class="f2">integerValue</span>];

    <span class="f1">[[userInfo objectForKey:UIKeyboardFrameEndUserInfoKey] getValue:&amp;keyboardEndFrame]</span><span class="f2">void(^animations)() = ^{</span>
<span class="f2">        inputViewBottomLayout.constant = -100;</span>
<span class="f2">    }</span>;

    <span class="f1">keyboardHeight</span><span class="f2">void(^completion)(BOOL)</span> = <span class="f1">keyboardEndFrame.size.height;</span><span class="f2">^(BOOL finished){</span>
        if (<span class="f1">animationDuration</span><span class="f2">messageList.count</span> &gt; 0) {<span class="f1">// Animate up or down</span>
            [<span class="f1">UIView beginAnimations:@&quot;contentMove&quot; context</span><span class="f2">tableView scrollToRowAtIndexPath</span>:<span class="f1">nil];</span>[<span class="f1">UIView setAnimationDuration</span><span class="f2">NSIndexPath indexPathForItem</span>:<span class="f1">animationDuration];</span>
<span class="f1">        [UIView setAnimationCurve</span><span class="f2">messageList.count-1 inSection</span>:<span class="f1">animationCurve</span><span class="f2">0</span>] <span class="f1">;</span>
<span class="f1">        [UIView setAnimationBeginsFromCurrentState</span><span class="f2">atScrollPosition:UITableViewScrollPositionBottom animated</span>:YES];
        }<span class="f1">CGRect newFrame = chatView.frame;</span>
<span class="f1">    </span>
<span class="f1">    if(!up)</span>
<span class="f1">        newFrame.origin.y = chatViewOriginY;</span>
<span class="f1">    else</span>
<span class="f1">    {</span>
<span class="f1">        newFrame.origin.y = self.view.frame.size.height - keyboardHeight - 50;</span>
    }<span class="f1">chatView.frame = newFrame</span>;

<span class="f1">if(animationDuration &gt; 0)</span>
<span class="f1">    {</span>    [UIView <span class="f1">commitAnimations</span><span class="f2">animateWithDuration:duration delay:0.0f options:(curve &lt;&lt; 16 | UIViewAnimationOptionBeginFromCurrentState) animations:animations completion:completion</span>];<span class="f1">}</span>
}
<span class="f2">//BQMM集成  keyboard相关的修改 结束</span>

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

<span class="f2">//BQMM集成  发送消息及按钮事件相关 开始   请对比所有的方法，做出修改</span>
- (<span class="f1">IBAction</span><span class="f2">void</span>)<span class="f1">sendClick</span><span class="f2">sendTextMessage</span>:(<span class="f1">UITextField</span><span class="f2">NSString</span>*)<span class="f1">sender</span><span class="f2">textMessage</span>
{
    <span class="f2">NSString *textMessage_ =</span> [<span class="f1">sender resignFirstResponder</span><span class="f2">textMessage stringByReplacingOccurrencesOfString:@&quot;\a&quot; withString:@&quot;&quot;</span>];
    <span class="f2">[MMTextParser localParseMMText:textMessage_ completionHandler:^(NSArray *textImgArray) {</span>
<span class="f2">        NSDictionary *ext = nil;</span>
<span class="f2">        NSString *sendStr = @&quot;&quot;;</span>
<span class="f2">        for (id obj in textImgArray) {</span>
            if (<span class="f1">sender.</span><span class="f2">[obj isKindOfClass:[MMEmoji class]]) {</span>
<span class="f2">                MMEmoji *emoji = (MMEmoji*)obj;</span>
<span class="f2">                if (!ext) {</span>
<span class="f2">                    ext = @{@&quot;txt_msgType&quot;:@&quot;emojitype&quot;,</span>
<span class="f2">                            @&quot;msg_data&quot;:[MMTextParser extDataWithTextImageArray:textImgArray]};</span>
<span class="f2">                }</span>
<span class="f2">                sendStr = [sendStr stringByAppendingString:[NSString stringWithFormat:@&quot;[%@]&quot;, emoji.emojiName]];</span>
<span class="f2">            }</span>
<span class="f2">            else if ([obj isKindOfClass:[NSString class]]) {</span>
<span class="f2">                sendStr = [sendStr stringByAppendingString:obj];</span>
<span class="f2">            }</span>
<span class="f2">        }</span>
<span class="f2">        </span>
<span class="f2">        GotyeOCMessage* msg = [GotyeOCMessage createTextMessage:chatTarget</span> text<span class="f1">.length &lt;=0</span><span class="f2">:textMessage];</span>
<span class="f2">        if (ext) {</span>
<span class="f2">            const char *extStr = [ext JSONRepresentation].UTF8String;</span>
<span class="f2">            [msg putExtraData:extStr len:(unsigned int)strlen(extStr)];</span>
<span class="f2">        }</span>
<span class="f2">        [GotyeOCAPI sendMessage:msg];</span>
<span class="f2">        </span>
<span class="f2">        [self reloadHistorys:YES];</span>
<span class="f2">    }];</span>
<span class="f2">}</span>

<span class="f2">- (void)sendMMFaceMesage:(MMEmoji*</span>)<span class="f1">return</span><span class="f2">emoji</span>
<span class="f2">{</span>
<span class="f2">    NSDictionary *ext = @{@&quot;txt_msgType&quot;:@&quot;facetype&quot;,</span>
<span class="f2">                          @&quot;msg_data&quot;:[MMTextParser extDataWithEmoji:emoji]};</span>
<span class="f2">    const char *extStr = [ext JSONRepresentation].UTF8String</span>;

    GotyeOCMessage* msg = [GotyeOCMessage createTextMessage:chatTarget text:<span class="f1">sender.text</span><span class="f2">[NSString stringWithFormat:@&quot;[%@]&quot;, emoji.emojiName]];</span>
<span class="f2">    [msg putExtraData:extStr len:(unsigned int)strlen(extStr)</span>];
    [GotyeOCAPI sendMessage:msg];

<span class="f1">    sender.text = @&quot;&quot;;</span>
<span class="f1">    </span>
    [self reloadHistorys:YES];
}

- (IBAction)voiceButtonClick:(id)sender
{
    <span class="f2">if ([[AVAudioSession sharedInstance] respondsToSelector:@selector(requestRecordPermission:)]) {</span>
<span class="f2">        [[AVAudioSession sharedInstance] performSelector:@selector(requestRecordPermission:) withObject:^(BOOL granted) {</span>
<span class="f2">            if (granted) {</span>
                [UIView beginAnimations:nil context:NULL];
                [UIView setAnimationDuration:0.2];

                buttonWrite.alpha = 1;
                buttonVoice.alpha = 0;
                inputView.frame = CGRectMake(inputView.frame.origin.x, -50, 320, 100);

                [UIView commitAnimations];

                [textInput resignFirstResponder];

            <span class="f2">}</span>
<span class="f2">            else {</span>
<span class="f2">                NSDictionary *infoDictionary = [[NSBundle mainBundle] infoDictionary];</span>
<span class="f2">                CFShow((__bridge CFTypeRef)(infoDictionary));</span>
<span class="f2">                NSString *app_Name = [infoDictionary objectForKey:@&quot;CFBundleDisplayName&quot;];</span>
<span class="f2">                </span>
<span class="f2">                dispatch_async(dispatch_get_main_queue(), ^{</span>
<span class="f2">                    [[[UIAlertView alloc] initWithTitle:@&quot;&quot;</span>
<span class="f2">                                                message:</span>
<span class="f2">                      [NSString stringWithFormat:@&quot;%@需要访问您的麦克风。\n请启用麦克风-设置/隐私/麦克风&quot;, app_Name]</span>
<span class="f2">                                               delegate:nil</span>
<span class="f2">                                      cancelButtonTitle:@&quot;确定&quot;</span>
<span class="f2">                                      otherButtonTitles:nil]</span>
<span class="f2">                     show];</span>
<span class="f2">                });</span>
<span class="f2">            }</span>
<span class="f2">        }];</span>
<span class="f2">    }</span>
}

- (IBAction)writeButtonClick:(id)sender
<span class="f6">@@ -292,31 +355,52 @@</span> - (IBAction)writeButtonClick:(id)sender

    buttonWrite.alpha = 0;
    buttonVoice.alpha = 1;
    inputView.frame = CGRectMake(inputView.frame.origin.x, 0, <span class="f1">320</span><span class="f2">ScreenWidth</span>, 100);

    [UIView commitAnimations];
}

- (IBAction)addButtonClick:(id)sender
{
    [<span class="f1">UIView beginAnimations:nil context:NULL];</span>
<span class="f1">    [UIView setAnimationDuration:0.2</span><span class="f2">self keyBoardHidden</span>];

    <span class="f1">CGRect frame</span><span class="f2">UIButton *button</span> = <span class="f1">chatView.frame</span><span class="f2">(UIButton *)sender;</span>
<span class="f2">    button.selected = !button.selected</span>;

    <span class="f2">CGFloat offect = -100;</span>
    if (<span class="f1">frame.origin.y &lt; self.view.frame</span><span class="f2">button</span>.<span class="f1">size.height - 50</span><span class="f2">selected</span>) <span class="f1">frame.origin.y = self.view.frame.size.height - 50;</span>
<span class="f1">    else</span>
<span class="f1">        frame.origin.y</span><span class="f2">{</span>
<span class="f2">        offect</span> = <span class="f1">self.view.frame.size.height - frame.size.height</span><span class="f2">0</span>;
    <span class="f2">}</span>

    <span class="f1">chatView.frame</span><span class="f2">void(^animations)()</span> = <span class="f1">frame;</span>
<span class="f1">    self</span><span class="f2">^{</span>
<span class="f2">        inputViewBottomLayout</span>.<span class="f1">tableView.frame</span><span class="f2">constant</span> = <span class="f1">CGRectMake(0, 0, 320, chatView.frame.origin.y)</span><span class="f2">offect;</span>
<span class="f2">    }</span>;

    <span class="f2">void(^completion)(BOOL) = ^(BOOL finished){</span>
<span class="f2">        if (messageList.count &gt; 0) {</span>
            [<span class="f1">UIView commitAnimations</span><span class="f2">tableView scrollToRowAtIndexPath:[NSIndexPath indexPathForItem:messageList.count-1 inSection:0] atScrollPosition:UITableViewScrollPositionBottom animated:YES];</span>
<span class="f2">        }</span>
<span class="f2">        buttonRealTime.hidden = ![GotyeOCAPI supportRealtime:chatTarget</span>];
        <span class="f2">[textInput resignFirstResponder];</span>
<span class="f2">    };</span>

<span class="f1">buttonRealTime.hidden = !</span>    [<span class="f1">GotyeOCAPI supportRealtime</span><span class="f2">UIView animateWithDuration:0.2f delay</span>:<span class="f1">chatTarget</span><span class="f2">0.0f options:(UIViewAnimationCurveLinear &lt;&lt; 16 | UIViewAnimationOptionBeginFromCurrentState) animations:animations completion:completion</span>];
<span class="f2">}</span>

<span class="f2">- (IBAction)faceButtonClick:(id)sender</span>
<span class="f2">{</span>
<span class="f2">    UIButton *button = (UIButton *)sender;</span>
<span class="f2">    button.selected = !button.selected;</span>

    <span class="f2">if (!</span>[textInput <span class="f1">resignFirstResponder</span><span class="f2">isFirstResponder]) {</span>
<span class="f2">        [textInput becomeFirstResponder];</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    if (button.isSelected) {</span>
<span class="f2">        [[MMEmotionCentre defaultCentre] attachEmotionKeyboardToInput:textInput];</span>
<span class="f2">    } else {</span>
<span class="f2">        [[MMEmotionCentre defaultCentre] switchToDefaultKeyboard</span>];
    <span class="f2">}</span>
}

-(void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary *)info
<span class="f6">@@ -350,6 +434,9 @@</span> - (IBAction)cameraButtonClick:(id)sender
{
    if([UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera])
    {
        <span class="f2">buttonWrite.alpha = 0;//解决在显示“按住说话”时拍照返回时界面显示bug</span>
<span class="f2">        buttonVoice.alpha = 1;</span>

        UIImagePickerController *imagePicker = [[UIImagePickerController alloc] init];

        imagePicker.delegate = self;
<span class="f6">@@ -367,8 +454,28 @@</span> - (IBAction)realtimeClick:(id)sender
{
    if(chatTarget.type == GotyeChatTargetTypeRoom &amp;&amp; [GotyeOCAPI supportRealtime:chatTarget])
    {
        <span class="f2">if ([[AVAudioSession sharedInstance] respondsToSelector:@selector(requestRecordPermission:)]) {</span>
<span class="f2">            [[AVAudioSession sharedInstance] performSelector:@selector(requestRecordPermission:) withObject:^(BOOL granted) {</span>
<span class="f2">                if (granted) {</span>
                    GotyeRealTimeVoiceController *viewController = [[GotyeRealTimeVoiceController alloc] initWithRoomID:(unsigned)chatTarget.id talkingID:talkingUserID];
                    [self.navigationController pushViewController:viewController animated:YES];
                <span class="f2">}</span>
<span class="f2">                else {</span>
<span class="f2">                    NSDictionary *infoDictionary = [[NSBundle mainBundle] infoDictionary];</span>
<span class="f2">                    CFShow((__bridge CFTypeRef)(infoDictionary));</span>
<span class="f2">                    NSString *appName = [infoDictionary objectForKey:@&quot;CFBundleDisplayName&quot;];</span>
<span class="f2">                    dispatch_async(dispatch_get_main_queue(), ^{</span>
<span class="f2">                        [[[UIAlertView alloc] initWithTitle:@&quot;&quot;</span>
<span class="f2">                                                    message:</span>
<span class="f2">                          [NSString stringWithFormat:@&quot;%@需要访问您的麦克风。\n请启用麦克风-设置/隐私/麦克风&quot;, appName]</span>
<span class="f2">                                                   delegate:nil</span>
<span class="f2">                                          cancelButtonTitle:@&quot;确定&quot;</span>
<span class="f2">                                          otherButtonTitles:nil]</span>
<span class="f2">                         show];</span>
<span class="f2">                    });</span>
<span class="f2">                }</span>
<span class="f2">            }];</span>
<span class="f2">        }</span>
    }
}

<span class="f6">@@ -381,8 +488,6 @@</span> -(IBAction)speakButtonDown:(id)sender
    {
        speakingView.hidden = NO;
    }
<span class="f1">    </span>
<span class="f1">//    self.navigationController.view.userInteractionEnabled = NO;</span>
}

-(IBAction)speakButtonUp:(id)sender
<span class="f6">@@ -392,8 +497,6 @@</span> -(IBAction)speakButtonUp:(id)sender
    [self reloadHistorys:YES];

    speakingView.hidden = YES;
<span class="f1">    </span>
<span class="f1">//    self.navigationController.view.userInteractionEnabled = YES;</span>
}

-(void)messageClick:(UIButton*)button
<span class="f6">@@ -403,6 +506,18 @@</span> -(void)messageClick:(UIButton*)button
    GotyeOCMessage* message = messageList[indexPath.row];

    switch (message.type) {
        <span class="f2">case GotyeMessageTypeText:</span>
<span class="f2">        {</span>
<span class="f2">            NSString *extStr = [[NSString alloc] initWithData:message.getExtraData encoding:NSUTF8StringEncoding];</span>
<span class="f2">            NSDictionary *ext = [NSJSONSerialization JSONObjectWithData:[extStr dataUsingEncoding:NSUTF8StringEncoding] options:NSJSONReadingMutableContainers error:nil];</span>
<span class="f2">            </span>
<span class="f2">            if ([ext[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">                [self keyBoardHidden];</span>
<span class="f2">                UIViewController *emojiController = [[MMEmotionCentre defaultCentre] controllerForEmotionCode:ext[@&quot;msg_data&quot;][0][0]];</span>
<span class="f2">                [self.navigationController pushViewController:emojiController animated:YES];</span>
<span class="f2">            }</span>
<span class="f2">        }</span>
<span class="f2">            break;</span>
        case GotyeMessageTypeAudio:
        {
            if(talkingUserID != nil)
<span class="f6">@@ -530,18 +645,21 @@</span> - (void)largeImageClose:(id)sender
- (void)groupSettingClick:(id)sender
{
    GotyeGroupSettingController *viewController = [[GotyeGroupSettingController alloc] initWithTarget:[GotyeOCAPI getGroupDetail:chatTarget forceRequest:NO]];
    <span class="f2">[GotyeOCAPI stopPlay];</span>
    [self.navigationController pushViewController:viewController animated:YES];
}

- (void)roomSettingClick:(id)sender
{
    GotyeChatRoomSettingController *viewController = [[GotyeChatRoomSettingController alloc] initWithTarget:[GotyeOCAPI getRoomDetail:chatTarget <span class="f2">forceRequest: NO]</span>]<span class="f2">;</span>
<span class="f2">    [GotyeOCAPI stopPlay</span>];
    [self.navigationController pushViewController:viewController animated:YES];
}

- (void)targetUserClick:(id)sender
{
    GotyeUserInfoController *viewController = [[GotyeUserInfoController alloc] initWithTarget:[GotyeOCAPI getUserDetail:chatTarget forceRequest:NO] groupID:0];
    <span class="f2">[GotyeOCAPI stopPlay];</span>
    [self.navigationController pushViewController:viewController animated:YES];
}

<span class="f6">@@ -550,14 +668,18 @@</span> - (void)userClick:(UIButton*)sender
    GotyeOCMessage* message = messageList[sender.tag];

    GotyeUserInfoController *viewController = [[GotyeUserInfoController alloc] initWithTarget:[GotyeOCAPI getUserDetail:message.sender forceRequest:NO] groupID:0];
    <span class="f2">[GotyeOCAPI stopPlay];</span>
    [self.navigationController pushViewController:viewController animated:YES];
}

- (void)scrollViewDidScroll:(UIScrollView *)scrollView
{
    if(loadingView.hidden &amp;&amp; scrollView.contentOffset.y &lt; -20 <span class="f2">&amp;&amp; hasscrollView</span>)
    {

        <span class="f2">hasscrollView = NO;</span>

        loadingView.frame = CGRectMake(0, -40, <span class="f1">320</span><span class="f2">ScreenWidth</span>, 40);
        [scrollView insertSubview:loadingView atIndex:0];
        loadingView.hidden = NO;
        [loadingView showLoading:haveMoreData];
<span class="f6">@@ -566,11 +688,15 @@</span> - (void)scrollViewDidScroll:(UIScrollView *)scrollView
        {
            NSInteger lastCount = messageList.count;
            messageList = [GotyeOCAPI getMessageList:chatTarget more:YES];
<span class="f2">//            messageList = [GotyeOCAPI getMessageList:chatTarget more:NO];</span>

            if(chatTarget.type != GotyeChatTargetTypeRoom)
            {
                if(lastCount == messageList.count)
                {
                    haveMoreData = NO;
                    <span class="f2">hasscrollView = YES;</span>

                    [loadingView showLoading:haveMoreData];
                }
                else
<span class="f6">@@ -580,22 +706,69 @@</span> - (void)scrollViewDidScroll:(UIScrollView *)scrollView

                    loadingView.hidden = YES;
                    [self reloadHistorys:NO];
                    <span class="f2">hasscrollView = YES;</span>

                    CGFloat newOffsetY = self.tableView.contentSize.height - lastContentHeight + lastOffsetY;

                    [self.tableView scrollRectToVisible:CGRectMake(0, newOffsetY, ScreenHeight, self.tableView.frame.size.height) animated:NO];
                }
            <span class="f2">}else {</span>

            }
        }
    }

}
<span class="f2">//BQMM集成  发送消息及按钮事件相关 结束   请对比所有的方法，做出修改</span>

<span class="f2">//BQMM集成  UITextViewDelegate</span>
<span class="f2">#pragma mark - *UITextViewDelegate</span>

<span class="f2">- (BOOL)textView:(UITextView *)textView shouldChangeTextInRange:(NSRange)range replacementText:(NSString *)text</span>
<span class="f2">{</span>
<span class="f2">    if ([text isEqualToString:@&quot;\n&quot;]) {</span>
<span class="f2">        [textView resignFirstResponder];</span>
<span class="f2">        </span>
<span class="f2">        if(textView.text.length &lt;= 0)</span>
<span class="f2">            return NO;</span>
<span class="f2">        </span>
<span class="f2">        [self sendTextMessage:textView.mmText];</span>
<span class="f2">        </span>
<span class="f2">        textView.text = @&quot;&quot;;</span>
<span class="f2">        </span>
<span class="f2">        return NO;</span>
<span class="f2">    }</span>
<span class="f2">    return YES;</span>
<span class="f2">}</span>

<span class="f2">- (void)textViewDidChange:(UITextView *)textView</span>
<span class="f2">{</span>
<span class="f2">    if (textView.markedTextRange == nil) {</span>
<span class="f2">        NSRange selectedRange = textView.selectedRange;</span>
<span class="f2">        textView.mmText = textView.mmText;</span>
<span class="f2">        textView.selectedRange = selectedRange;</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (void)textViewDidBeginEditing:(UITextView *)textView</span>
<span class="f2">{</span>
<span class="f2">    buttonAdd.selected = NO;</span>
<span class="f2">    buttonWrite.alpha = 0;</span>
<span class="f2">    buttonVoice.alpha = 1;</span>
<span class="f2">}</span>

<span class="f2">- (void)textViewDidEndEditing:(UITextView *)textView</span>
<span class="f2">{</span>
<span class="f2">    buttonFace.selected = NO;</span>
<span class="f2">    buttonWrite.alpha = 0;</span>
<span class="f2">    buttonVoice.alpha = 1;</span>
<span class="f2">}</span>

#pragma mark - Gotye UI delegates

- (void)onSendMessage:(GotyeStatusCode)code message:(GotyeOCMessage*)message
{

    [self reloadHistorys:YES];

    if(message.type == GotyeMessageTypeImage)
<span class="f6">@@ -627,7 +800,9 @@</span> - (void)onGetMessageList:(GotyeStatusCode)code msglist:(NSArray *)msgList downlo
//    }

     *downloadMediaIfNeed = true;
    <span class="f2">//BQMM集成</span>
<span class="f2">    hasscrollView = YES;</span>

    loadingView.hidden = YES;
    haveMoreData = (msgList.count &gt; 0);
}
<span class="f6">@@ -646,6 +821,30 @@</span> - (void)onUserDismissGroup:(GotyeOCGroup*)group user:(GotyeOCUser*)user
    }
}

<span class="f2">- (void)onUserKickedFromGroup:(GotyeOCGroup*)group kicked:(GotyeOCUser*)kicked actor:(GotyeOCUser*)actor</span>
<span class="f2">{</span>
<span class="f2">    GotyeOCUser* myself = [GotyeOCAPI getLoginUser];</span>
<span class="f2">    if ([myself.name isEqualToString:kicked.name]) {</span>
<span class="f2">        </span>
<span class="f2">        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:nil message:@&quot;您已被群主移出该群！&quot; delegate:nil cancelButtonTitle:nil otherButtonTitles:nil, nil];</span>
<span class="f2">        [alert show];</span>
<span class="f2">        [self performSelector:@selector(dismissAlert:) withObject:alert afterDelay:1.0];</span>
<span class="f2">        [GotyeOCAPI deleteSession:group alsoRemoveMessages:NO];</span>
<span class="f2">    }else {</span>
<span class="f2">        </span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">}</span>

<span class="f2">- (void)dismissAlert:(UIAlertView *)alert</span>
<span class="f2">{</span>
<span class="f2">    if (alert) {</span>
<span class="f2">        [alert dismissWithClickedButtonIndex:[alert cancelButtonIndex] animated:YES];</span>
<span class="f2">        </span>
<span class="f2">        [GotyeUIUtil popToRootViewControllerForNavgaion:self.navigationController animated:YES];</span>
<span class="f2">    }</span>
<span class="f2">}</span>

- (void)onPlayStop
{
    for(UITableViewCell* cell in self.tableView.visibleCells)
<span class="f6">@@ -667,6 +866,8 @@</span> - (void)onRealPlayStart:(GotyeStatusCode)code speaker:(GotyeOCUser*)speaker room
    labelRealTimeStart.text = [NSString stringWithFormat:@&quot;%@发起了实时对讲&quot;, talkingUserID];

    [self.view addSubview:realtimeStartView];
    <span class="f2">//BQMM集成</span>
<span class="f2">    realtimeStartView.hidden = NO;</span>
}

- (void)onStopTalk:(GotyeStatusCode)code realtime:(bool)realtime message:(GotyeOCMessage*)message cancelSending:(bool *)cancelSending
<span class="f6">@@ -680,16 +881,20 @@</span> - (void)onStopTalk:(GotyeStatusCode)code realtime:(bool)realtime message:(GotyeO
                                              otherButtonTitles:nil, nil];
        [alert show];
    }
<span class="f1">    </span>
    speakingView.hidden = YES;

<span class="f1">    </span>
    *cancelSending = YES;
    if (<span class="f2">code == GotyeStatusCodeOK) {</span>
<span class="f2">        //BQMM 集成</span>
<span class="f2">        if(</span>message.text<span class="f1">!= nil</span> &amp;&amp; message.text.length &gt; 0){
            <span class="f1">[message putExtraData:</span><span class="f2">//        const char* cstring =</span> [message.text UTF8String]<span class="f2">;</span>
<span class="f2">            //        [message putExtraData: cstring</span> len: strlen(<span class="f1">[</span><span class="f2">cstring)];</span>
<span class="f2">            message.extraText =</span> message.text<span class="f1">UTF8String])</span><span class="f2">;</span>
<span class="f2">        }</span>
<span class="f2">        </span>
<span class="f2">        [GotyeOCAPI sendMessage: message</span>];
    }
    <span class="f1">[GotyeOCAPI sendMessage: message]</span><span class="f2">//*cancelSending = YES</span>;
    //[GotyeOCAPI decodeAudioMessage:message];
}

<span class="f6">@@ -834,6 +1039,14 @@</span> - (void)VoiceRecognitionClientErrorStatus:(int) aStatus subStatus:(int)aSubStatu
    decodingMessage = nil;
}
*/

<span class="f2">-(void) onReport:(GotyeStatusCode)code message:(GotyeOCMessage*)message;</span>
<span class="f2">{</span>
<span class="f2">    if (code == GotyeStatusCodeOK) {</span>
<span class="f2">        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@&quot;举报成功&quot; message:nil delegate:nil cancelButtonTitle:@&quot;确定&quot; otherButtonTitles:nil, nil];</span>
<span class="f2">        [alert show];</span>
<span class="f2">    }</span>
<span class="f2">}</span>
#pragma mark - table delegate &amp; data

- (NSInteger) tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
<span class="f6">@@ -855,17 +1068,18 @@</span> - (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPa
            showDate = YES;
    }

    return [GotyeChatBubbleView getbubbleHeight:message <span class="f2">target:chatTarget</span> showDate:showDate];
}

<span class="f2">//BQMM集成</span>
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    static NSString *MessageCellIdentifier = @&quot;MessageCellIdentifier&quot;;

    <span class="f1">UITableViewCell</span><span class="f2">GotyeChatTableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:MessageCellIdentifier];
    if(cell == nil)
    {
        cell = [[<span class="f1">UITableViewCell</span><span class="f2">GotyeChatTableViewCell</span> alloc] init];
    }

    for (UIView *view in [cell.contentView subviews]) {
<span class="f6">@@ -884,7 +1098,7 @@</span> - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(N
            showDate = YES;
    }

    UIView *bubble = [GotyeChatBubbleView BubbleWithMessage:message <span class="f2">target:chatTarget</span> showDate:showDate];

    UIButton *msgButton = (UIButton *)[(UIButton*)bubble viewWithTag:bubbleMessageButtonTag];
    msgButton.tag = indexPath.row;
<span class="f6">@@ -904,12 +1118,126 @@</span> - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(N

    cell.backgroundColor = [UIColor clearColor];

    <span class="f2">cell.didSelectedCell = ^(id sender){</span>
<span class="f2">        GotyeOCMessage *mess = [[GotyeOCMessage alloc] init];</span>
<span class="f2">        mess = messageList[_indexRow];</span>
<span class="f2">        [GotyeOCAPI report:0 content:@&quot;fff&quot; message:mess];</span>
<span class="f2">    };</span>
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [tableView deselectRowAtIndexPath:indexPath animated:NO];
    <span class="f2">if (playingRow == indexPath.row) {</span>
<span class="f2">        </span>
<span class="f2">        double delayInSeconds = 0.1;</span>
<span class="f2">        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * NSEC_PER_SEC));</span>
<span class="f2">        dispatch_after(popTime, dispatch_get_main_queue(), ^(void){</span>
<span class="f2">            UITableViewCell *cell = [self.tableView cellForRowAtIndexPath:indexPath];</span>
<span class="f2">            UIImageView *voiceImage = (UIImageView*)[cell viewWithTag:bubblePlayImageTag];</span>
<span class="f2">            [voiceImage startAnimating];</span>
<span class="f2">        });</span>
<span class="f2">        </span>
<span class="f2">    }else {</span>
<span class="f2">        </span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (BOOL)tableView:(UITableView *)tableView shouldShowMenuForRowAtIndexPath:(NSIndexPath *)indexPath</span>
<span class="f2">{</span>
<span class="f2">    </span>
<span class="f2">    UIMenuController *menu=[UIMenuController sharedMenuController];</span>
<span class="f2">    UIMenuItem *flag = [[UIMenuItem alloc] initWithTitle:@&quot;举报&quot;action:@selector(test:)];</span>
<span class="f2">    [menu setMenuItems:[NSArray arrayWithObjects:flag, nil]];</span>
<span class="f2">    [[UIMenuController sharedMenuController] update];</span>
<span class="f2">    _indexRow = indexPath.row;</span>
<span class="f2">    return YES;</span>
<span class="f2">}</span>
<span class="f2">- (BOOL)tableView:(UITableView *)tableView canPerformAction:(SEL)action forRowAtIndexPath:(NSIndexPath *)indexPath withSender:(id)sender</span>
<span class="f2">{</span>
<span class="f2">    if (action == @selector(test:)){</span>
<span class="f2">        return YES;</span>
<span class="f2">    }  else {</span>
<span class="f2">        return NO;</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">//- (BOOL)canBecomeFirstResponder</span>
<span class="f2">//{</span>
<span class="f2">//    return YES;</span>
<span class="f2">//}</span>
<span class="f2">//- (BOOL)becomeFirstResponder {</span>
<span class="f2">//    return YES;</span>
<span class="f2">//}</span>
<span class="f2">//</span>
<span class="f2">- (void)test:(id)sender {</span>
<span class="f2">    </span>
<span class="f2">}</span>
<span class="f2">//</span>
<span class="f2">//-(BOOL)canPerformAction:(SEL)action withSender:(id)sender</span>
<span class="f2">//{</span>
<span class="f2">//    if(action ==@selector(test:)){</span>
<span class="f2">//        </span>
<span class="f2">//        return YES;</span>
<span class="f2">//    }</span>
<span class="f2">//    return [super canPerformAction:action withSender:sender];</span>
<span class="f2">//}</span>

<span class="f2">- (void)tableView:(UITableView *)tableView performAction:(SEL)action forRowAtIndexPath:(NSIndexPath *)indexPath withSender:(id)sender</span>
<span class="f2">{</span>
<span class="f2">    </span>
<span class="f2">}</span>

<span class="f2">//BQMM集成 MMEmotionCentreDelegate</span>
<span class="f2">#pragma mark - *MMEmotionCentreDelegate</span>
<span class="f2">- (void)didSelectEmoji:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    [self sendMMFaceMesage:emoji];</span>
<span class="f2">}</span>

<span class="f2">- (void)didSelectTipEmoji:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    [self sendMMFaceMesage:emoji];</span>
<span class="f2">    textInput.text = @&quot;&quot;;</span>
<span class="f2">}</span>

<span class="f2">- (void)didSendWithInput:(UIResponder&lt;UITextInput&gt; *)input</span>
<span class="f2">{</span>
<span class="f2">    UITextView *inputTextView = (UITextView *)input;</span>
<span class="f2">    </span>
<span class="f2">    [inputTextView resignFirstResponder];</span>
<span class="f2">    </span>
<span class="f2">    if(inputTextView.text.length &lt;= 0)</span>
<span class="f2">        return;</span>
<span class="f2">    </span>
<span class="f2">    [self sendTextMessage:inputTextView.mmText];</span>
<span class="f2">    </span>
<span class="f2">    inputTextView.text = @&quot;&quot;;</span>
<span class="f2">}</span>

<span class="f2">- (void)tapOverlay</span>
<span class="f2">{</span>
<span class="f2">    self.buttonFace.selected = NO;</span>
}

@end


<span class="bold">diff --git a/GotyeIM/UI/ChatView/GotyeInputTextView.h b/GotyeIM/UI/ChatView/GotyeInputTextView.h</span>
<span class="bold">new file mode 100644</span>
<span class="bold">index 0000000..68d517b</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/GotyeIM/UI/ChatView/GotyeInputTextView.h</span>
<span class="f6">@@ -0,0 +1,13 @@</span>
<span class="f2">//</span>
<span class="f2">//  GotyeInputTextView.h</span>
<span class="f2">//  GotyeIM</span>
<span class="f2">//</span>
<span class="f2">//  Created by LiChao Jun on 16/3/17.</span>
<span class="f2">//  Copyright © 2016年 Gotye. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &lt;UIKit/UIKit.h&gt;</span>

<span class="f2">@interface GotyeInputTextView : UITextView</span>

<span class="f2">@end</span>
<span class="bold">diff --git a/GotyeIM/UI/ChatView/GotyeInputTextView.m b/GotyeIM/UI/ChatView/GotyeInputTextView.m</span>
<span class="bold">new file mode 100644</span>
<span class="bold">index 0000000..5913f71</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/GotyeIM/UI/ChatView/GotyeInputTextView.m</span>
<span class="f6">@@ -0,0 +1,39 @@</span>
<span class="f2">//</span>
<span class="f2">//  GotyeInputTextView.m</span>
<span class="f2">//  GotyeIM</span>
<span class="f2">//</span>
<span class="f2">//  Created by LiChao Jun on 16/3/17.</span>
<span class="f2">//  Copyright © 2016年 Gotye. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &quot;GotyeInputTextView.h&quot;</span>

<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

<span class="f2">@implementation GotyeInputTextView</span>

<span class="f2">- (void)select:(id)sender {</span>
<span class="f2">    NSRange selectedRange = self.selectedRange;</span>
<span class="f2">    if (selectedRange.location &lt; self.text.length) {</span>
<span class="f2">        self.selectedRange = NSMakeRange(selectedRange.location, 1);</span>
<span class="f2">    } else {</span>
<span class="f2">        self.selectedRange = NSMakeRange(selectedRange.location - 1, 1);</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (void)copy:(id)sender {</span>
<span class="f2">    [UIPasteboard generalPasteboard].string = [self mmTextWithRange:self.selectedRange];</span>
<span class="f2">}</span>

<span class="f2">- (void)cut:(id)sender {</span>
<span class="f2">    [UIPasteboard generalPasteboard].string = [self mmTextWithRange:self.selectedRange];</span>
<span class="f2">    NSRange range  = [self.mmText rangeOfString:[UIPasteboard generalPasteboard].string];</span>
<span class="f2">    NSString *left = [self.mmText substringToIndex:range.location];</span>
<span class="f2">    NSString *right = [self.mmText substringFromIndex:range.location + range.length];</span>
<span class="f2">    NSRange selectedRange = self.selectedRange;</span>
<span class="f2">    self.mmText = [NSString stringWithFormat:@&quot;%@%@&quot;, left, right];</span>
<span class="f2">    self.selectedRange = NSMakeRange(selectedRange.location, 0);</span>
<span class="f2">    [self.delegate textViewDidChange:self];</span>
<span class="f2">}</span>

<span class="f2">@end</span>
</pre>
</body>
</html>
